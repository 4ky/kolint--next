#!/usr/bin/env bun

import { exists } from "node:fs/promises";
import { join } from "node:path";
import { createProjectGraphAsync } from "nx/src/project-graph/project-graph";

await generateTsconfig();
process.exit(0);

/**
 * This script generates the 'tsconfig.json' file that references all other
 * projects. It is used to type-check all projects simultaneously.
 */
async function generateTsconfig() {
  const projectGraph = await createProjectGraphAsync();

  const projectRootPaths = Object.values(projectGraph.nodes).map(
    (node) => node.data.root,
  );

  const references = [];
  for (const path of projectRootPaths) {
    const tsconfigPath = join(path, "tsconfig.json");
    if (await exists(tsconfigPath)) {
      references.push(tsconfigPath);
    }
  }
  references.sort();

  const content = `{
    // Automatically generated by scripts/prepare.
    "references": [
      ${references
        .map((path) => `{ "path": ${JSON.stringify(path)} }`)
        .join(",\n    ")}
    ],
    "include": []
  }`;
  await Bun.write("tsconfig.json", content);
}
